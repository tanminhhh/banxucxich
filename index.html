<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>TanMinh Dev_</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  html {
    scroll-behavior: smooth;
  }
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #fff8f0;
    color: #4a3c31;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    max-width: 400px;
    margin: auto;
    padding: 15px;
    user-select: none;
    position: relative;
  }
  h1 {
    text-align: center;
    margin-bottom: 12px;
    color: #d95d39;
    text-shadow: 1px 1px 4px #f2a65a;
  }
  h2 {
    margin-top: 20px;
    border-bottom: 3px solid #d95d39;
    padding-bottom: 4px;
    color: #d95d39;
  }
  label {
    display: block;
    margin: 8px 0 2px;
    font-weight: 700;
    font-size: 16px;
  }
  input[type="number"], input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid #d95d39;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s;
    color: #4a3c31;
  }
  input[type="number"]:focus, input[type="text"]:focus {
    border-color: #f2a65a;
    outline: none;
  }
  button {
    margin-top: 18px;
    background-color: #d95d39;
    border: none;
    color: white;
    padding: 14px 0;
    width: 100%;
    border-radius: 12px;
    font-size: 20px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s;
    user-select: none;
  }
  button:hover,
  button:focus {
    background-color: #b44a2a;
  }
  #top-buttons {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
  }
  #open-history-btn,
  #open-expense-history-btn,
  #open-bank-code-btn {
    background-color: #2a7ae2;
    color: white;
    border-radius: 10px;
    font-weight: 700;
    font-size: 16px;
    padding: 12px 0;
    cursor: pointer;
    border: none;
    user-select: none;
    flex: 1;
    transition: background-color 0.3s ease;
  }
  #open-history-btn:hover,
  #open-expense-history-btn:hover,
  #open-bank-code-btn:hover {
    background-color: #1f5bb8;
  }
  .section {
    background: #fff2e8;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 4px 10px rgb(217 93 57 / 0.4);
    margin-bottom: 30px;
  }
  .status {
    font-size: 18px;
    font-weight: 700;
    margin-top: 10px;
    color: #4a3c31;
    text-align: center;
  }
  .numbers {
    font-size: 22px;
    font-weight: 900;
    color: #d95d39;
    margin-top: 5px;
    text-align: center;
    user-select: text;
  }
  .small-text {
    text-align: center;
    font-size: 14px;
    color: #8f7a68;
    margin-top: 8px;
  }

  /* Modal styling */
  #history-modal,
  #expense-history-modal,
  #bank-code-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
  }
  #history-modal-content,
  #expense-history-modal-content,
  #bank-code-modal-content {
    background-color: #fff8f0;
    margin: 40px auto;
    border-radius: 16px;
    padding: 20px;
    max-width: 95%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    position: relative;
  }
  #history-modal-content h2,
  #expense-history-modal-content h2,
  #bank-code-modal-content h2 {
    margin-top: 0;
    color: #d95d39;
    text-align: center;
  }
  .modal-close-btn {
    position: absolute;
    right: 12px;
    top: 12px;
    background: none;
    font-size: 24px;
    border: none;
    color: #d95d39;
    cursor: pointer;
    font-weight: 700;
    user-select: none;
  }
  #history-list,
  #expense-history-list {
    margin-top: 12px;
  }
  #bank-code-img {
    display: block;
    max-width: 100%;
    margin: 10px auto 0 auto;
    border-radius: 12px;
    box-shadow: 0 0 8px rgba(0,0,0,0.15);
  }

  .daily-group {
    border: 1px solid #d95d39;
    border-radius: 10px;
    margin-bottom: 18px;
    background: #fef6f0;
    padding: 10px 14px;
  }
  .daily-group-header {
    font-weight: 700;
    font-size: 16px;
    color: #b54125;
    margin-bottom: 8px;
    border-bottom: 1px solid #d95d39;
    padding-bottom: 4px;
  }
  .daily-summary {
    color: #a94528;
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 8px;
  }
  .daily-transaction {
    margin-left: 12px;
    margin-bottom: 4px;
  }
  .daily-transaction-time {
    font-size: 12px;
    color: #825029;
    margin-left: 8px;
  }

  @media (max-width: 420px) {
    body {
      max-width: 100%;
      padding: 12px;
    }
    label {
      font-size: 14px;
    }
    input[type=number], input[type=text] {
      font-size: 14px;
      padding: 8px 10px;
    }
    button,
    #open-history-btn,
    #open-expense-history-btn,
    #open-bank-code-btn {
      font-size: 16px;
      padding: 10px 0;
    }
    .numbers {
      font-size: 20px;
    }
  }
</style>
</head>
<body>
<h1>TanMinh Dev_</h1>

<div id="top-buttons" role="region" aria-label="N√∫t m·ªü c√°c c·ª≠a s·ªï l·ªãch s·ª≠ v√† m√£ ng√¢n h√†ng">
  <button id="open-history-btn" aria-haspopup="dialog" aria-controls="history-modal-content" aria-expanded="false" aria-label="M·ªü l·ªãch s·ª≠ b√°n h√†ng">L·ªãch s·ª≠ b√°n h√†ng</button>
  <button id="open-expense-history-btn" aria-haspopup="dialog" aria-controls="expense-history-modal-content" aria-expanded="false" aria-label="M·ªü l·ªãch s·ª≠ chi ti√™u kh√°c">L·ªãch s·ª≠ chi ti√™u</button>
  <button id="open-bank-code-btn" aria-haspopup="dialog" aria-controls="bank-code-modal-content" aria-expanded="false" aria-label="Hi·ªÉn th·ªã m√£ ng√¢n h√†ng">M√£ Ng√¢n H√†ng</button>
</div>

<div class="section" id="price-section">
  <h2>Gi√° b√°n v√† gi√° v·ªën / c√¢y</h2>
  <label for="price-per-stick">Gi√° b√°n 1 c√¢y (VNƒê)</label>
  <input type="number" id="price-per-stick" placeholder="V√≠ d·ª•: 2000" min="0" step="100" required />
  <label for="cost-per-stick" style="margin-top:12px;">Gi√° v·ªën 1 c√¢y (VNƒê)</label>
  <input type="number" id="cost-per-stick" placeholder="V√≠ d·ª•: 1500" min="0" step="100" required />
</div>

<div class="section" id="purchase-section">
  <h2>Nh·∫≠p h√†ng (b·ªï sung t·ªìn kho)</h2>
  <label for="purchase-quantity">S·ªë l∆∞·ª£ng c√¢y x√∫c x√≠ch nh·∫≠p v·ªÅ</label>
  <input type="number" id="purchase-quantity" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng" min="1" step="1" />
  <button id="btn-purchase">Nh·∫≠p h√†ng</button>
</div>

<div class="section" id="sale-section">
  <h2>B√°n h√†ng</h2>
  <label for="sale-quantity">S·ªë l∆∞·ª£ng c√¢y x√∫c x√≠ch b√°n</label>
  <input type="number" id="sale-quantity" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng" min="0" step="1" />
  <label for="gift-quantity" style="margin-top: 12px;">S·ªë l∆∞·ª£ng c√¢y x√∫c x√≠ch t·∫∑ng (n·∫øu c√≥)</label>
  <input type="number" id="gift-quantity" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng t·∫∑ng" min="0" step="1" />
  <button id="btn-sale">X√°c nh·∫≠n b√°n & t·∫∑ng</button>
</div>

<div class="section" id="expense-section">
  <h2>Chi ti√™u kh√°c</h2>
  <label for="expense-amount">S·ªë ti·ªÅn chi ti√™u (VNƒê)</label>
  <input type="number" id="expense-amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn" min="1" step="100" />
  <label for="expense-desc" style="margin-top:8px;">M√¥ t·∫£ (t√πy ch·ªçn)</label>
  <input type="text" id="expense-desc" placeholder="V√≠ d·ª•: ph√≠ v·∫≠n chuy·ªÉn, ƒëi·ªán n∆∞·ªõc..." maxlength="100" />
  <button id="btn-add-expense">Th√™m chi ti√™u</button>
</div>

<div class="section" id="status-section">
  <h2>Tr·∫°ng th√°i h√†ng t·ªìn, doanh thu v√† chi ti√™u</h2>
  <div class="status">S·ªë c√¢y x√∫c x√≠ch c√≤n l·∫°i:</div>
  <div class="numbers" id="stock-count">0</div>
  <div class="status">T·ªïng doanh thu hi·ªán t·∫°i:</div>
  <div class="numbers" id="total-revenue">0 ƒë</div>
  <div class="status" style="margin-top: 12px;">T·ªïng l·ª£i nhu·∫≠n hi·ªán t·∫°i:</div>
  <div class="numbers" id="total-profit">0 ƒë</div>
  <div class="status" style="margin-top: 12px;">T·ªïng chi ti√™u kh√°c:</div>
  <div class="numbers" id="total-expenses">0 ƒë</div>
  <div class="status" style="margin-top: 12px;">L·ª£i nhu·∫≠n r√≤ng (sau chi ti√™u):</div>
  <div class="numbers" id="net-profit">0 ƒë</div>
  <div class="small-text">D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.</div>
</div>

<!-- Modal for sales history -->
<div id="history-modal" role="dialog" aria-modal="true" aria-labelledby="history-modal-title" tabindex="-1">
  <div id="history-modal-content">
    <button class="modal-close-btn" id="history-modal-close" aria-label="ƒê√≥ng c·ª≠a s·ªï l·ªãch s·ª≠ b√°n h√†ng">&times;</button>
    <h2 id="history-modal-title">L·ªãch s·ª≠ b√°n h√†ng theo ng√†y</h2>
    <div id="history-list" aria-live="polite">
      <!-- Daily grouped sales transactions will appear here -->
    </div>
  </div>
</div>

<!-- Modal for expense history -->
<div id="expense-history-modal" role="dialog" aria-modal="true" aria-labelledby="expense-history-modal-title" tabindex="-1">
  <div id="expense-history-modal-content">
    <button class="modal-close-btn" id="expense-history-modal-close" aria-label="ƒê√≥ng c·ª≠a s·ªï l·ªãch s·ª≠ chi ti√™u">&times;</button>
    <h2 id="expense-history-modal-title">L·ªãch s·ª≠ chi ti√™u kh√°c</h2>
    <div id="expense-history-list" aria-live="polite">
      <!-- Expense entries here -->
    </div>
  </div>
</div>

<!-- Modal for Bank Code -->
<div id="bank-code-modal" role="dialog" aria-modal="true" aria-labelledby="bank-code-modal-title" tabindex="-1">
  <div id="bank-code-modal-content">
    <button class="modal-close-btn" id="bank-code-modal-close" aria-label="ƒê√≥ng c·ª≠a s·ªï m√£ ng√¢n h√†ng">&times;</button>
    <h2 id="bank-code-modal-title">M√£ Ng√¢n H√†ng</h2>
    <img id="bank-code-img" src="https://i.imgur.com/YuByekc.jpeg" alt="M√£ ng√¢n h√†ng TanMinh Dev_" />
  </div>
</div>

<script>
  (() => {
    "use strict";

    const STORAGE_KEY = 'sausage_sales_manager_v7';

    // Elements
    const priceInput = document.getElementById('price-per-stick');
    const costInput = document.getElementById('cost-per-stick');
    const purchaseQuantityInput = document.getElementById('purchase-quantity');
    const saleQuantityInput = document.getElementById('sale-quantity');
    const giftQuantityInput = document.getElementById('gift-quantity');
    const expenseAmountInput = document.getElementById('expense-amount');
    const expenseDescInput = document.getElementById('expense-desc');
    const btnPurchase = document.getElementById('btn-purchase');
    const btnSale = document.getElementById('btn-sale');
    const btnAddExpense = document.getElementById('btn-add-expense');
    const stockCountElem = document.getElementById('stock-count');
    const totalRevenueElem = document.getElementById('total-revenue');
    const totalProfitElem = document.getElementById('total-profit');
    const totalExpensesElem = document.getElementById('total-expenses');
    const netProfitElem = document.getElementById('net-profit');
    const historyListElem = document.getElementById('history-list');
    const expenseHistoryListElem = document.getElementById('expense-history-list');

    const historyModal = document.getElementById('history-modal');
    const historyModalContent = document.getElementById('history-modal-content');
    const historyModalCloseBtn = document.getElementById('history-modal-close');
    const openHistoryBtn = document.getElementById('open-history-btn');

    const expenseHistoryModal = document.getElementById('expense-history-modal');
    const expenseHistoryModalContent = document.getElementById('expense-history-modal-content');
    const expenseHistoryModalCloseBtn = document.getElementById('expense-history-modal-close');
    const openExpenseHistoryBtn = document.getElementById('open-expense-history-btn');

    const bankCodeModal = document.getElementById('bank-code-modal');
    const bankCodeModalContent = document.getElementById('bank-code-modal-content');
    const bankCodeModalCloseBtn = document.getElementById('bank-code-modal-close');
    const openBankCodeBtn = document.getElementById('open-bank-code-btn');

    // Data structure:
    // { pricePerStick, costPerStick, stock, revenue, profit, transactions: [], expenses: [] }
    // transactions: { type: 'sale' | 'purchase' | 'gift', quantity, timestamp, totalPrice, profit }
    // expenses: { amount, timestamp, description }
    let data = {
      pricePerStick: 2000,
      costPerStick: 1500,
      stock: 0,
      revenue: 0,
      profit: 0,
      transactions: [],
      expenses: []
    };

    // Load data from localStorage
    function loadData() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if(saved) {
        try {
          const parsed = JSON.parse(saved);
          if(typeof parsed.pricePerStick === 'number') data.pricePerStick = parsed.pricePerStick;
          if(typeof parsed.costPerStick === 'number') data.costPerStick = parsed.costPerStick;
          if(typeof parsed.stock === 'number') data.stock = parsed.stock;
          if(typeof parsed.revenue === 'number') data.revenue = parsed.revenue;
          if(typeof parsed.profit === 'number') data.profit = parsed.profit;
          if(Array.isArray(parsed.transactions)) data.transactions = parsed.transactions;
          if(Array.isArray(parsed.expenses)) data.expenses = parsed.expenses;
        } catch(e) {
          // ignore parse error
        }
      }
    }

    // Save data to localStorage
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // Format timestamp to human readable date time string
    function formatTimestamp(ts) {
      const d = new Date(ts);
      return d.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit', year: 'numeric'}) +
        ' ' +
        d.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
    }

    // Format timestamp to date string for grouping
    function formatDate(ts, forId=false) {
      const d = new Date(ts);
      if(forId) {
        return d.toISOString().slice(0,10);
      }
      return d.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit', year: 'numeric'});
    }

    // Update UI
    function updateUI() {
      priceInput.value = data.pricePerStick.toString();
      costInput.value = data.costPerStick.toString();
      stockCountElem.textContent = data.stock.toString();
      totalRevenueElem.textContent = data.revenue.toLocaleString('vi-VN') + ' ƒë';
      totalProfitElem.textContent = data.profit.toLocaleString('vi-VN') + ' ƒë';

      const totalExpenses = data.expenses.reduce((sum, e) => sum + e.amount, 0);
      totalExpensesElem.textContent = totalExpenses.toLocaleString('vi-VN') + ' ƒë';

      const netProfit = data.profit - totalExpenses;
      netProfitElem.textContent = netProfit.toLocaleString('vi-VN') + ' ƒë';

      renderGroupedSalesHistory();
      renderExpenseHistory();
    }

    // Render sales history grouped by day
    function renderGroupedSalesHistory() {
      historyListElem.innerHTML = '';
      const salesAndGifts = data.transactions.filter(t => t.type === 'sale' || t.type === 'gift');
      if(salesAndGifts.length === 0) {
        historyListElem.textContent = 'Ch∆∞a c√≥ giao d·ªãch b√°n h√†ng ho·∫∑c t·∫∑ng n√†o.';
        return;
      }

      const grouped = {};
      for (const trans of salesAndGifts) {
        const dateStr = formatDate(trans.timestamp);
        const dateId = formatDate(trans.timestamp, true);
        if (!grouped[dateStr]) grouped[dateStr] = {id: dateId, transactions: []};
        grouped[dateStr].transactions.push(trans);
      }

      const sortedDates = Object.keys(grouped).sort((a,b) => {
        const da = new Date(a.split('/').reverse().join('-')).getTime();
        const db = new Date(b.split('/').reverse().join('-')).getTime();
        return db - da;
      });

      sortedDates.forEach(date => {
        const dayGroup = grouped[date];
        const dayTransactions = dayGroup.transactions;

        const totalQty = dayTransactions.reduce((sum,t) => sum + t.quantity, 0);
        const totalRevenue = dayTransactions.reduce((sum,t) => sum + (t.type === 'sale' ? t.totalPrice : 0), 0);
        const totalProfit = dayTransactions.reduce((sum,t) => sum + t.profit, 0);

        const dayDiv = document.createElement('div');
        dayDiv.className = 'daily-group';
        dayDiv.id = 'day-' + dayGroup.id;

        const header = document.createElement('div');
        header.className = 'daily-group-header';
        header.textContent = date;
        dayDiv.appendChild(header);

        const summary = document.createElement('div');
        summary.className = 'daily-summary';
        summary.textContent = `T·ªïng s·ªë: ${totalQty} c√¢y - Doanh thu: ${totalRevenue.toLocaleString('vi-VN')} ƒë - L·ª£i nhu·∫≠n: ${totalProfit.toLocaleString('vi-VN')} ƒë`;
        dayDiv.appendChild(summary);

        dayTransactions.forEach(t => {
          const isSale = t.type === 'sale';
          const isGift = t.type === 'gift';
          const time = new Date(t.timestamp).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
          const transDiv = document.createElement('div');
          transDiv.className = 'daily-transaction';
          const icon = isSale ? 'üõí' : 'üéÅ';
          transDiv.textContent = `${icon} ${t.quantity} c√¢y - ${isSale ? `T·ªïng: ${t.totalPrice.toLocaleString('vi-VN')} ƒë` : 'T·∫∑ng kh√¥ng doanh thu'} - L·ª£i nhu·∫≠n: ${t.profit.toLocaleString('vi-VN')} ƒë`;

          const timeSpan = document.createElement('span');
          timeSpan.className = 'daily-transaction-time';
          timeSpan.textContent = time;
          transDiv.appendChild(timeSpan);
          dayDiv.appendChild(transDiv);
        });

        historyListElem.appendChild(dayDiv);
      });
    }

    // Render expense history
    function renderExpenseHistory() {
      expenseHistoryListElem.innerHTML = '';
      if(data.expenses.length === 0) {
        expenseHistoryListElem.textContent = 'Ch∆∞a c√≥ chi ti√™u n√†o.';
        return;
      }
      for(let i = data.expenses.length -1; i >=0; i--) {
        const e = data.expenses[i];
        const div = document.createElement('div');
        div.className = 'expense-entry';

        const amountDiv = document.createElement('div');
        amountDiv.style.fontWeight = '700';
        amountDiv.style.color = '#b23c2a';
        amountDiv.textContent = `- ${e.amount.toLocaleString('vi-VN')} ƒë`;

        const descDiv = document.createElement('div');
        descDiv.className = 'expense-meta';
        descDiv.textContent = `${e.description ? e.description : '(Kh√¥ng m√¥ t·∫£)'} - Th·ªùi gian: ${formatTimestamp(e.timestamp)}`;

        div.appendChild(amountDiv);
        div.appendChild(descDiv);

        expenseHistoryListElem.appendChild(div);
      }
    }

    // Validation functions
    function validatePrice(value) {
      const n = Number(value);
      return Number.isInteger(n) && n >= 0;
    }
    function validateQuantity(value) {
      const n = Number(value);
      return Number.isInteger(n) && n >= 0;
    }
    function validateExpenseAmount(value) {
      const n = Number(value);
      return Number.isInteger(n) && n > 0;
    }

    // Price/Cost inputs handler
    function onPriceChange() {
      const priceVal = priceInput.value;
      const costVal = costInput.value;

      if(!validatePrice(priceVal)) {
        alert('Vui l√≤ng nh·∫≠p gi√° b√°n h·ª£p l·ªá (s·ªë nguy√™n >= 0).');
        priceInput.value = data.pricePerStick;
        return false;
      }
      if(!validatePrice(costVal)) {
        alert('Vui l√≤ng nh·∫≠p gi√° v·ªën h·ª£p l·ªá (s·ªë nguy√™n >= 0).');
        costInput.value = data.costPerStick;
        return false;
      }
      if(Number(costVal) > Number(priceVal)) {
        if(!confirm('Gi√° v·ªën > Gi√° b√°n. B·∫°n c√≥ ch·∫Øc kh√¥ng?')) {
          costInput.value = data.costPerStick;
          return false;
        }
      }
      data.pricePerStick = Number(priceVal);
      data.costPerStick = Number(costVal);
      saveData();
      updateUI();
      return true;
    }

    priceInput.addEventListener('change', onPriceChange);
    costInput.addEventListener('change', onPriceChange);

    // Purchase button
    btnPurchase.addEventListener('click', () => {
      let val = purchaseQuantityInput.value;
      if(!validateQuantity(val) || val === "0") {
        alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng nh·∫≠p h√†ng h·ª£p l·ªá (> 0).');
        purchaseQuantityInput.focus();
        return;
      }
      const qty = Number(val);
      const totalCost = qty * data.costPerStick;

      data.stock += qty;
      data.transactions.push({
        type: 'purchase',
        quantity: qty,
        timestamp: Date.now(),
        totalPrice: totalCost,
        profit: 0
      });
      saveData();
      updateUI();
      purchaseQuantityInput.value = '';
      purchaseQuantityInput.focus();
    });

    // Sale button (including gift)
    btnSale.addEventListener('click', () => {
      let saleVal = saleQuantityInput.value;
      let giftVal = giftQuantityInput.value;
      if (!validateQuantity(saleVal)) {
        alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng b√°n h√†ng h·ª£p l·ªá (>= 0).');
        saleQuantityInput.focus();
        return;
      }
      if (!validateQuantity(giftVal)) {
        alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng t·∫∑ng h·ª£p l·ªá (>= 0).');
        giftQuantityInput.focus();
        return;
      }
      const saleQty = Number(saleVal);
      const giftQty = Number(giftVal);
      if(saleQty === 0 && giftQty === 0) {
        alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng b√°n ho·∫∑c t·∫∑ng l·ªõn h∆°n 0.');
        saleQuantityInput.focus();
        return;
      }
      const totalQty = saleQty + giftQty;
      if(totalQty > data.stock) {
        alert('Kh√¥ng ƒë·ªß x√∫c x√≠ch trong kho ƒë·ªÉ b√°n ho·∫∑c t·∫∑ng. Vui l√≤ng ki·ªÉm tra l·∫°i.');
        if (saleQty > 0) saleQuantityInput.focus();
        else giftQuantityInput.focus();
        return;
      }

      const now = Date.now();

      // Process sale
      if(saleQty > 0) {
        const totalSale = saleQty * data.pricePerStick;
        const totalCost = saleQty * data.costPerStick;
        const profit = totalSale - totalCost;

        data.stock -= saleQty;
        data.revenue += totalSale;
        data.profit += profit;
        data.transactions.push({
          type: 'sale',
          quantity: saleQty,
          timestamp: now,
          totalPrice: totalSale,
          profit: profit
        });
      }

      // Process gift
      if(giftQty > 0) {
        const totalCost = giftQty * data.costPerStick;
        const profit = -totalCost; // The cost is a loss since no revenue

        data.stock -= giftQty;
        data.profit += profit;
        data.transactions.push({
          type: 'gift',
          quantity: giftQty,
          timestamp: now,
          totalPrice: 0,
          profit: profit
        });
      }

      saveData();
      updateUI();
      saleQuantityInput.value = '';
      giftQuantityInput.value = '';
      saleQuantityInput.focus();
    });

    // Add expense button
    btnAddExpense.addEventListener('click', () => {
      let val = expenseAmountInput.value;
      if(!validateExpenseAmount(val)) {
        alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn chi ti√™u h·ª£p l·ªá (> 0).');
        expenseAmountInput.focus();
        return;
      }
      const amount = Number(val);
      let desc = expenseDescInput.value.trim();

      data.expenses.push({
        amount: amount,
        description: desc,
        timestamp: Date.now()
      });
      saveData();
      updateUI();
      expenseAmountInput.value = '';
      expenseDescInput.value = '';
      expenseAmountInput.focus();
    });

    // Modal utilities
    function openModal(modal, openBtn) {
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden', 'false');
      openBtn.setAttribute('aria-expanded', 'true');
      const closeBtn = modal.querySelector('.modal-close-btn');
      closeBtn.focus();
    }
    function closeModal(modal, openBtn) {
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      openBtn.setAttribute('aria-expanded', 'false');
      openBtn.focus();
    }

    // Open/Close sales history modal
    openHistoryBtn.addEventListener('click', () => {
      openModal(historyModal, openHistoryBtn);
    });
    historyModalCloseBtn.addEventListener('click', () => {
      closeModal(historyModal, openHistoryBtn);
    });

    // Open/Close expense history modal
    openExpenseHistoryBtn.addEventListener('click', () => {
      openModal(expenseHistoryModal, openExpenseHistoryBtn);
    });
    expenseHistoryModalCloseBtn.addEventListener('click', () => {
      closeModal(expenseHistoryModal, openExpenseHistoryBtn);
    });

    // Open/Close bank code modal
    openBankCodeBtn.addEventListener('click', () => {
      openModal(bankCodeModal, openBankCodeBtn);
    });
    bankCodeModalCloseBtn.addEventListener('click', () => {
      closeModal(bankCodeModal, openBankCodeBtn);
    });

    // Close modals on click outside content
    window.addEventListener('click', (event) => {
      if(event.target === historyModal) {
        closeModal(historyModal, openHistoryBtn);
      }
      else if(event.target === expenseHistoryModal) {
        closeModal(expenseHistoryModal, openExpenseHistoryBtn);
      }
      else if(event.target === bankCodeModal) {
        closeModal(bankCodeModal, openBankCodeBtn);
      }
    });

    // Close modals on ESC key press
    window.addEventListener('keydown', (event) => {
      if(event.key === "Escape") {
        if(historyModal.style.display === 'block') closeModal(historyModal, openHistoryBtn);
        if(expenseHistoryModal.style.display === 'block') closeModal(expenseHistoryModal, openExpenseHistoryBtn);
        if(bankCodeModal.style.display === 'block') closeModal(bankCodeModal, openBankCodeBtn);
      }
    });

    // Initialize app
    function init() {
      loadData();
      updateUI();
    }

    init();

  })();
</script>
</body>
</html>

